name: Check Release Version

on:
  pull_request:
    types: [labeled, synchronize, opened, reopened]
    branches: [main, dev]

jobs:
  check-version:
    name: Validate Release Version
    # Only run if PR has release or test-release label
    if: |
      contains(github.event.pull_request.labels.*.name, 'release') ||
      contains(github.event.pull_request.labels.*.name, 'test-release')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0  # Need full history to check tags

      - name: Load workflow config
        run: |
          if [ -f .github/workflows/config.env ]; then
            grep -v '^#' .github/workflows/config.env | grep -v '^$' >> $GITHUB_ENV
          fi

      - name: Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | cut -d'"' -f2)
          TAG="v$VERSION"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Version in PR: $VERSION"
          echo "ðŸ·ï¸  Tag to create: $TAG"

      - name: Check if tag already exists (for production releases only)
        if: |
          github.event.pull_request.base.ref == env.MAIN_BRANCH &&
          contains(github.event.pull_request.labels.*.name, 'release')
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          # Fetch tags from remote
          git fetch --tags

          if git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "âŒ Error: Tag $TAG already exists!"
            echo ""
            echo "This version has already been released."
            echo "Please bump the version in pyproject.toml before merging."
            echo ""
            echo "Current version in PR: ${{ steps.version.outputs.version }}"
            echo "Tag already exists: $TAG"
            echo ""
            echo "View existing releases: https://github.com/${{ github.repository }}/releases"
            exit 1
          fi

          echo "âœ… Tag $TAG is available - ready for release!"
          echo ""
          echo "When this PR is merged, version ${{ steps.version.outputs.version }} will be released."

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if version follows semantic versioning pattern
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-(rc|alpha|beta|dev|a|b)[0-9]+)?$'; then
            echo "âš ï¸  Warning: Version doesn't follow semantic versioning: $VERSION"
            echo "Expected format: MAJOR.MINOR.PATCH or MAJOR.MINOR.PATCH-{rc|alpha|beta|dev}N"
            echo ""
            echo "Examples:"
            echo "  - 1.0.0 (stable release)"
            echo "  - 1.0.0-rc1 (release candidate)"
            echo "  - 1.0.0-beta1 (beta release)"
            echo ""
            echo "This won't block the release, but consider following semantic versioning."
          else
            echo "âœ… Version follows semantic versioning: $VERSION"
          fi

      - name: Enforce version format rules
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          HAS_RELEASE_LABEL: ${{ contains(github.event.pull_request.labels.*.name, 'release') }}
          HAS_TEST_LABEL: ${{ contains(github.event.pull_request.labels.*.name, 'test-release') }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if version has pre-release identifier
          if echo "$VERSION" | grep -qE '(rc|alpha|beta|dev|a[0-9]|b[0-9])'; then
            IS_PRERELEASE=true
            echo "ðŸ“‹ Detected pre-release version: $VERSION"
          else
            IS_PRERELEASE=false
            echo "ðŸ“‹ Detected stable version: $VERSION"
          fi

          echo ""
          echo "ðŸ” Validation Rules:"
          echo "   Branch: $BASE_REF"
          echo "   Labels: release=$HAS_RELEASE_LABEL, test-release=$HAS_TEST_LABEL"
          echo "   Version type: $([ "$IS_PRERELEASE" = "true" ] && echo "pre-release" || echo "stable")"
          echo ""

          # RULE 1: main + release label â†’ MUST be stable version
          if [ "$BASE_REF" == "$MAIN_BRANCH" ] && [ "$HAS_RELEASE_LABEL" == "true" ]; then
            if [ "$IS_PRERELEASE" = "true" ]; then
              echo "âŒ ERROR: Production release on $MAIN_BRANCH requires stable version"
              echo ""
              echo "   Branch: $MAIN_BRANCH"
              echo "   Label: release"
              echo "   Version: $VERSION (pre-release)"
              echo ""
              echo "   $MAIN_BRANCH branch with 'release' label can only have stable versions."
              echo ""
              echo "   âœ… Valid:   1.0.0, 1.2.3, 2.0.0"
              echo "   âŒ Invalid: 1.0.0rc1, 1.0.0b3, 1.0.0a1"
              echo ""
              echo "   To fix: uv version --bump-to X.Y.Z"
              exit 1
            fi
            echo "âœ… Valid: $MAIN_BRANCH + release + stable version"
            echo "ðŸŽ¯ Target: Production PyPI"
            echo "ðŸ·ï¸  Will create tag: v$VERSION"
          fi

          # RULE 2: dev + test-release label â†’ MUST be pre-release version
          if [ "$BASE_REF" == "$DEV_BRANCH" ] && [ "$HAS_TEST_LABEL" == "true" ]; then
            if [ "$IS_PRERELEASE" = "false" ]; then
              echo "âŒ ERROR: Test release on $DEV_BRANCH requires pre-release version"
              echo ""
              echo "   Branch: $DEV_BRANCH"
              echo "   Label: test-release"
              echo "   Version: $VERSION (stable)"
              echo ""
              echo "   $DEV_BRANCH branch with 'test-release' label must have pre-release versions."
              echo ""
              echo "   âœ… Valid:   1.0.0rc1, 1.0.0b3, 1.0.0a1"
              echo "   âŒ Invalid: 1.0.0, 1.2.3, 2.0.0"
              echo ""
              echo "   To fix: uv version --bump-to X.Y.ZrcN"
              exit 1
            fi
            echo "âœ… Valid: $DEV_BRANCH + test-release + pre-release version"
            echo "ðŸŽ¯ Target: TestPyPI"
            echo "ðŸ·ï¸  Will NOT create tag (test release)"
          fi

          # RULE 3: Catch invalid branch/label combinations
          if [ "$BASE_REF" == "$MAIN_BRANCH" ] && [ "$HAS_TEST_LABEL" == "true" ]; then
            echo "âŒ ERROR: Invalid combination - 'test-release' label on $MAIN_BRANCH branch"
            echo ""
            echo "   Use 'release' label for $MAIN_BRANCH branch"
            echo "   Use 'test-release' label for $DEV_BRANCH branch"
            exit 1
          fi

          if [ "$BASE_REF" == "$DEV_BRANCH" ] && [ "$HAS_RELEASE_LABEL" == "true" ]; then
            echo "âŒ ERROR: Invalid combination - 'release' label on $DEV_BRANCH branch"
            echo ""
            echo "   Use 'test-release' label for $DEV_BRANCH branch"
            echo "   Use 'release' label for $MAIN_BRANCH branch"
            exit 1
          fi

      - name: Summary
        run: |
          echo "## âœ… Release Version Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This PR is ready to be merged and will trigger a release." >> $GITHUB_STEP_SUMMARY
